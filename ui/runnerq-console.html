<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>RunnerQ Console</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                /* Dark mode (default) */
                --bg-primary: #0f172a;
                --bg-secondary: #1e293b;
                --bg-tertiary: #334155;
                --bg-dark: #020617;
                --bg-darker: #0a0f1a;
                --bg-hover: #1e293b;
                --border: rgba(148, 163, 184, 0.12);
                --border-hover: rgba(148, 163, 184, 0.24);
                --text-primary: #f1f5f9;
                --text-secondary: #94a3b8;
                --text-tertiary: #64748b;
                --text-light: #ffffff;
                --accent-blue: #3b82f6;
                --accent-blue-hover: #2563eb;
                --accent-blue-light: rgba(59, 130, 246, 0.15);
                --accent-green: #15803d;
                --accent-red: #ef4444;
                --accent-yellow: #f59e0b;
                --accent-purple: #8b5cf6;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
                --shadow:
                    0 4px 6px -1px rgba(0, 0, 0, 0.4),
                    0 2px 4px -1px rgba(0, 0, 0, 0.3);
                --shadow-lg:
                    0 10px 15px -3px rgba(0, 0, 0, 0.5),
                    0 4px 6px -2px rgba(0, 0, 0, 0.4);
                --shadow-xl:
                    0 20px 25px -5px rgba(0, 0, 0, 0.6),
                    0 10px 10px -5px rgba(0, 0, 0, 0.3);
            }

            [data-theme="light"] {
                /* Light mode */
                --bg-primary: #f8fafc;
                --bg-secondary: #ffffff;
                --bg-tertiary: #f1f5f9;
                --bg-dark: #0f172a;
                --bg-darker: #1e293b;
                --bg-hover: #f1f5f9;
                --border: rgba(15, 23, 42, 0.1);
                --border-hover: rgba(15, 23, 42, 0.2);
                --text-primary: #0f172a;
                --text-secondary: #475569;
                --text-tertiary: #64748b;
                --text-light: #ffffff;
                --accent-blue: #3b82f6;
                --accent-blue-hover: #2563eb;
                --accent-blue-light: rgba(59, 130, 246, 0.1);
                --accent-green: #15803d;
                --accent-red: #ef4444;
                --accent-yellow: #f59e0b;
                --accent-purple: #8b5cf6;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                --shadow:
                    0 4px 6px -1px rgba(0, 0, 0, 0.1),
                    0 2px 4px -1px rgba(0, 0, 0, 0.06);
                --shadow-lg:
                    0 10px 15px -3px rgba(0, 0, 0, 0.1),
                    0 4px 6px -2px rgba(0, 0, 0, 0.05);
                --shadow-xl:
                    0 20px 25px -5px rgba(0, 0, 0, 0.1),
                    0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter",
                    "SF Pro Display", Roboto, sans-serif;
                background: var(--bg-primary);
                color: var(--text-primary);
                line-height: 1.6;
                min-height: 100vh;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }

            .app-shell {
                min-height: 100vh;
                display: flex;
                flex-direction: column;
            }

            .app-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 1.5rem;
                padding: 1rem 2rem;
                background: var(--bg-secondary);
                border-bottom: 1px solid var(--border);
                color: var(--text-light);
                box-shadow: var(--shadow-sm);
                position: sticky;
                top: 0;
                z-index: 100;
                backdrop-filter: blur(10px);
            }

            .logo {
                width: 40px;
                height: 40px;
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                font-size: 20px;
                color: white;
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
            }

            .header-content {
                display: flex;
                flex-direction: column;
                gap: 0.125rem;
            }

            .header-content h1 {
                font-size: 1.25rem;
                font-weight: 600;
                color: var(--text-primary);
                letter-spacing: -0.02em;
            }

            .subtitle {
                margin: 0;
                color: var(--text-secondary);
                font-size: 0.8125rem;
                font-weight: 400;
            }

            .worker-info {
                background: var(--bg-tertiary);
                border: 1px solid var(--border);
                border-radius: 6px;
                padding: 0.5rem 0.875rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                margin-left: auto;
            }

            .theme-toggle {
                background: var(--bg-tertiary);
                border: 1px solid var(--border);
                border-radius: 6px;
                padding: 0.5rem 0.875rem;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
                cursor: pointer;
                transition: all 0.15s;
                font-size: 0.875rem;
                color: var(--text-primary);
                margin-left: 0.5rem;
            }

            .theme-toggle:hover {
                background: var(--bg-hover);
                border-color: var(--border-hover);
            }

            .theme-toggle-icon {
                font-size: 1rem;
                line-height: 1;
            }

            .worker-info-label {
                font-size: 0.75rem;
                color: var(--text-secondary);
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .worker-info-value {
                font-size: 0.875rem;
                color: var(--text-primary);
                font-weight: 600;
            }

            .app-main {
                flex: 1;
                padding: 1.5rem;
                display: flex;
                flex-direction: column;
                gap: 1.5rem;
                max-width: 1800px;
                margin: 0 auto;
                width: 100%;
            }

            /* Stats Grid */
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                gap: 1rem;
            }

            .stats-card {
                background: var(--bg-secondary);
                border-radius: 8px;
                padding: 1.25rem 1.5rem;
                box-shadow: var(--shadow);
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
                border: 1px solid var(--border);
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
            }

            .stats-card::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 3px;
                height: 100%;
                background: currentColor;
                opacity: 0.8;
            }

            .stats-card:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
                border-color: var(--border-hover);
            }

            .stats-card.pending {
                border-left-color: #0ea5e9;
                color: #0ea5e9;
            }
            .stats-card.processing {
                border-left-color: #3b82f6;
                color: #3b82f6;
            }
            .stats-card.critical {
                border-left-color: #ef4444;
                color: #ef4444;
            }
            .stats-card.high {
                border-left-color: #f97316;
                color: #f97316;
            }
            .stats-card.normal {
                border-left-color: #15803d;
                color: #15803d;
            }
            .stats-card.low {
                border-left-color: #a855f7;
                color: #a855f7;
            }
            .stats-card.scheduled {
                border-left-color: #0891b2;
                color: #0891b2;
            }
            .stats-card.dead-letter {
                border-left-color: #64748b;
                color: #64748b;
            }

            .stats-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .stats-label {
                font-size: 0.75rem;
                color: var(--text-secondary);
                text-transform: uppercase;
                letter-spacing: 0.1em;
                font-weight: 600;
            }

            .stats-trend {
                font-size: 0.75rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 0.25rem;
                opacity: 0;
                transition: opacity 0.3s;
            }

            .stats-card:hover .stats-trend {
                opacity: 1;
            }

            .stats-trend.up {
                color: #15803d;
            }

            .stats-trend.down {
                color: #ef4444;
            }

            .stats-value {
                font-size: 2rem;
                font-weight: 700;
                color: var(--text-primary);
                line-height: 1;
                letter-spacing: -0.02em;
            }

            .stats-bar {
                height: 4px;
                background: var(--bg-primary);
                border-radius: 2px;
                overflow: hidden;
                position: relative;
            }

            .stats-bar-fill {
                height: 100%;
                background: currentColor;
                border-radius: 2px;
                transition: width 0.5s ease;
            }

            /* Priority Stats Section */
            .priority-stats {
                background: var(--bg-secondary);
                border-radius: 8px;
                padding: 1.25rem 1.5rem;
                box-shadow: var(--shadow);
                border: 1px solid var(--border);
                display: flex;
                align-items: center;
                gap: 2rem;
                transition: all 0.2s;
                flex-wrap: wrap;
            }

            .priority-stats-title {
                font-size: 0.85rem;
                font-weight: 600;
                color: var(--text-secondary);
                text-transform: uppercase;
                letter-spacing: 0.05em;
                min-width: 100px;
            }

            .priority-items {
                display: flex;
                gap: 2rem;
                flex: 1;
                flex-wrap: wrap;
            }

            .priority-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .priority-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                flex-shrink: 0;
            }

            .priority-dot.critical {
                background: #ef4444;
            }
            .priority-dot.high {
                background: #f97316;
            }
            .priority-dot.normal {
                background: #15803d;
            }
            .priority-dot.low {
                background: #a855f7;
            }

            .priority-item-label {
                font-size: 0.85rem;
                color: var(--text-secondary);
                font-weight: 500;
            }

            .priority-item-value {
                font-size: 1.1rem;
                font-weight: 700;
                color: var(--text-primary);
                min-width: 30px;
                text-align: right;
            }

            /* Content Grid */
            .content-grid {
                display: grid;
                grid-template-columns: minmax(0, 2.5fr) minmax(360px, 1fr);
                gap: 1.5rem;
            }

            /* Activities Section */
            .activities {
                background: var(--bg-secondary);
                border-radius: 8px;
                box-shadow: var(--shadow);
                border: 1px solid var(--border);
                display: flex;
                flex-direction: column;
                max-height: calc(100vh - 280px);
                overflow: hidden;
            }

            #activity-table-container {
                overflow-y: auto;
                flex: 1;
                min-height: 0;
            }

            .section-header {
                padding: 1rem 1.5rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid var(--border);
                background: var(--bg-tertiary);
            }

            .tabs {
                display: inline-flex;
                border-radius: 6px;
                background: var(--bg-primary);
                padding: 3px;
                gap: 3px;
                border: 1px solid var(--border);
            }

            .tabs button {
                border: none;
                background: transparent;
                padding: 0.5rem 1rem;
                border-radius: 4px;
                font-weight: 500;
                color: var(--text-secondary);
                cursor: pointer;
                transition: all 0.15s;
                font-size: 0.8125rem;
            }

            .tabs button.active {
                background: var(--accent-blue);
                color: var(--text-light);
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            }

            .tabs button:hover:not(.active) {
                background: var(--bg-tertiary);
                color: var(--text-primary);
            }

            .collection-count {
                font-size: 0.85rem;
                color: var(--text-secondary);
            }

            /* Activity Table */
            .activity-table {
                width: 100%;
                border-collapse: collapse;
            }

            .activity-table thead {
                background: var(--bg-tertiary);
                text-align: left;
                font-size: 0.75rem;
                color: var(--text-secondary);
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                position: sticky;
                top: 0;
                z-index: 10;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }

            .activity-table th {
                padding: 0.875rem 1.5rem;
                border-bottom: 1px solid var(--border);
                cursor: pointer;
                user-select: none;
                transition: background 0.15s;
            }

            .activity-table th:hover {
                background: var(--bg-hover);
            }

            .activity-table th.sortable {
                position: relative;
                padding-right: 2rem;
            }

            .activity-table th.sortable::after {
                content: "↕";
                position: absolute;
                right: 0.75rem;
                opacity: 0.3;
                font-size: 0.9rem;
            }

            .activity-table th.sortable.sorted-asc::after {
                content: "↑";
                opacity: 1;
                color: var(--accent-blue);
            }

            .activity-table th.sortable.sorted-desc::after {
                content: "↓";
                opacity: 1;
                color: var(--accent-blue);
            }

            .activity-table td {
                padding: 1rem 1.5rem;
                border-bottom: 1px solid var(--border);
                vertical-align: middle;
            }

            .activity-table tbody tr {
                cursor: pointer;
                transition: all 0.15s;
                position: relative;
                border-left: 3px solid transparent;
            }

            .activity-table tbody tr:hover {
                background: var(--bg-hover);
            }

            .activity-table tbody tr.selected {
                background: var(--accent-blue-light);
                border-left-color: var(--accent-blue);
            }

            .activity-table tbody tr.selected td:first-child {
                border-left: 3px solid var(--accent-blue);
            }

            .activity-type {
                font-weight: 600;
                color: var(--text-primary);
                margin-bottom: 0.25rem;
            }

            .activity-id {
                font-family: "Monaco", "Courier New", monospace;
                font-size: 0.75rem;
                color: var(--text-secondary);
                word-break: break-all;
            }

            .priority {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 0.2rem 0.7rem;
                border-radius: 999px;
                font-size: 0.75rem;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .priority.Critical {
                background: rgba(239, 68, 68, 0.2);
                color: #f87171;
            }

            .priority.High {
                background: rgba(249, 115, 22, 0.2);
                color: #fb923c;
            }

            .priority.Normal {
                background: rgba(21, 128, 61, 0.2);
                color: #16a34a;
            }

            .priority.Low {
                background: rgba(168, 85, 247, 0.2);
                color: #a78bfa;
            }

            .status-badge {
                display: inline-flex;
                align-items: center;
                padding: 0.35rem 0.85rem;
                border-radius: 999px;
                font-size: 0.75rem;
                font-weight: 600;
                letter-spacing: 0.02em;
                text-transform: capitalize;
            }

            /* Status Colors */
            .status-badge.Running {
                background: rgba(59, 130, 246, 0.2);
                color: #60a5fa;
                border: 1px solid rgba(59, 130, 246, 0.4);
            }
            .status-badge.Pending {
                background: rgba(148, 163, 184, 0.2);
                color: #94a3b8;
                border: 1px solid rgba(148, 163, 184, 0.4);
            }
            .status-badge.Completed {
                background: rgba(21, 128, 61, 0.2);
                color: #16a34a;
                border: 1px solid rgba(21, 128, 61, 0.4);
            }
            .status-badge.Failed {
                background: rgba(239, 68, 68, 0.2);
                color: #f87171;
                border: 1px solid rgba(239, 68, 68, 0.4);
            }
            .status-badge.Retrying {
                background: rgba(245, 158, 11, 0.2);
                color: #fbbf24;
                border: 1px solid rgba(245, 158, 11, 0.4);
            }
            .status-badge.DeadLetter {
                background: rgba(107, 114, 128, 0.2);
                color: #9ca3af;
                border: 1px solid rgba(107, 114, 128, 0.4);
            }
            .status-badge.Scheduled {
                background: rgba(139, 92, 246, 0.2);
                color: #a78bfa;
                border: 1px solid rgba(139, 92, 246, 0.4);
            }
            .status-badge.Enqueued {
                background: rgba(148, 163, 184, 0.2);
                color: #94a3b8;
                border: 1px solid rgba(148, 163, 184, 0.4);
            }
            .status-badge.Started {
                background: rgba(59, 130, 246, 0.2);
                color: #60a5fa;
                border: 1px solid rgba(59, 130, 246, 0.4);
            }
            .status-badge.Dequeued {
                background: rgba(59, 130, 246, 0.2);
                color: #60a5fa;
                border: 1px solid rgba(59, 130, 246, 0.4);
            }
            .status-badge.Deduplicated {
                background: rgba(139, 92, 246, 0.2);
                color: #a78bfa;
                border: 1px solid rgba(139, 92, 246, 0.4);
            }

            /* Detail Panel */
            .detail-panel {
                background: var(--bg-secondary);
                border-radius: 8px;
                box-shadow: var(--shadow-lg);
                border: 1px solid var(--border);
                padding: 1.5rem;
                display: flex;
                flex-direction: column;
                gap: 1.5rem;
                max-height: calc(100vh - 240px);
                overflow-y: auto;
                position: sticky;
                top: 2rem;
            }

            .detail-panel.empty {
                align-items: center;
                justify-content: center;
                color: var(--text-secondary);
                font-style: italic;
                min-height: 300px;
            }

            .detail-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                gap: 1rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid var(--border);
                margin-bottom: 0.5rem;
            }

            .detail-header h2 {
                font-size: 1.25rem;
                font-weight: 700;
            }

            .close-btn {
                background: var(--bg-tertiary);
                border: 1px solid var(--border);
                padding: 0.5rem 0.875rem;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 500;
                color: var(--text-secondary);
                transition: all 0.15s;
                font-size: 0.875rem;
            }

            .close-btn:hover {
                background: var(--bg-hover);
                border-color: var(--border-hover);
                color: var(--text-primary);
            }

            .detail-section {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }

            .detail-section h3 {
                font-size: 0.875rem;
                font-weight: 600;
                color: var(--text-primary);
                text-transform: uppercase;
                letter-spacing: 0.05em;
                margin-bottom: 0.75rem;
            }

            .detail-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .detail-item {
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
            }

            .detail-label {
                font-size: 0.75rem;
                text-transform: uppercase;
                color: var(--text-secondary);
                letter-spacing: 0.05em;
                font-weight: 600;
            }

            .detail-value {
                font-weight: 600;
                color: var(--text-primary);
            }

            .metadata-list {
                list-style: none;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .metadata-item {
                background: var(--bg-tertiary);
                padding: 0.75rem 1rem;
                border-radius: 6px;
                border: 1px solid var(--border);
                display: flex;
                justify-content: space-between;
                gap: 1rem;
                font-size: 0.85rem;
            }

            .metadata-key {
                font-weight: 600;
                color: var(--text-secondary);
            }

            .metadata-value {
                font-family: "Monaco", "Courier New", monospace;
                color: var(--text-primary);
            }

            /* Timeline View Toggle */
            .timeline-controls {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.75rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .view-toggle {
                display: inline-flex;
                border-radius: 4px;
                background: var(--bg-primary);
                padding: 2px;
                gap: 2px;
            }

            .view-toggle button {
                border: none;
                background: transparent;
                padding: 0.3125rem 0.625rem;
                border-radius: 3px;
                font-weight: 500;
                color: var(--text-secondary);
                cursor: pointer;
                transition: all 0.15s;
                font-size: 0.75rem;
            }

            .view-toggle button.active {
                background: var(--accent-blue);
                color: white;
            }

            .view-toggle button:hover:not(.active) {
                background: var(--accent-blue-light);
            }

            /* Timeline Styles */
            .timeline {
                list-style: none;
                display: flex;
                flex-direction: column;
                gap: 0.375rem;
            }

            .timeline-item:hover {
                background: var(--accent-blue-light);
            }

            /* Event-specific colors */
            .timeline-item.Enqueued {
                border-left-color: #9ca3af;
            }
            .timeline-item.Dequeued {
                border-left-color: #3b82f6;
            }
            .timeline-item.Started {
                border-left-color: #3b82f6;
            }
            .timeline-item.Running {
                border-left-color: #3b82f6;
            }
            .timeline-item.Completed {
                border-left-color: #15803d;
            }
            .timeline-item.Failed {
                border-left-color: #ef4444;
            }
            .timeline-item.Retrying {
                border-left-color: #f59e0b;
            }
            .timeline-item.Scheduled {
                border-left-color: #8b5cf6;
            }
            .timeline-item.LeaseExtended {
                border-left-color: #06b6d4;
            }
            .timeline-item.DeadLetter {
                border-left-color: #6b7280;
            }
            .timeline-item.ResultStored {
                border-left-color: #8b5cf6;
            }

            .timeline-detail {
                background: var(--bg-darker);
                color: var(--text-light);
                padding: 0.5rem 0.625rem;
                border-radius: 4px;
                font-size: 0.75rem;
                font-family: "Monaco", "Courier New", monospace;
                overflow-x: auto;
                margin-top: 0.375rem;
                max-width: 100%;
                word-wrap: break-word;
                line-height: 1.5;
            }

            /* Visual Timeline (horizontal bars) */
            .timeline-visual {
                position: relative;
                padding: 2rem 0;
                overflow-x: auto;
            }

            .timeline-bar-container {
                position: relative;
                min-height: 60px;
                margin-bottom: 1rem;
            }

            .timeline-bar {
                position: relative;
                height: 32px;
                background: linear-gradient(
                    90deg,
                    rgba(59, 130, 246, 0.8),
                    rgba(139, 92, 246, 0.8)
                );
                border-radius: 6px;
                display: flex;
                align-items: center;
                padding: 0 0.75rem;
                color: white;
                font-size: 0.8rem;
                font-weight: 600;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                transition: all 0.2s;
                cursor: pointer;
            }

            .timeline-bar:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            }

            .timeline-bar.completed {
                background: linear-gradient(90deg, #15803d, #16a34a);
            }

            .timeline-bar.failed {
                background: linear-gradient(90deg, #ef4444, #dc2626);
            }

            .timeline-bar.running {
                background: linear-gradient(90deg, #3b82f6, #2563eb);
                animation: pulse 2s ease-in-out infinite;
            }

            .timeline-bar.retrying {
                background: linear-gradient(90deg, #f59e0b, #d97706);
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.8;
                }
            }

            .timeline-markers {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 100%;
                pointer-events: none;
            }

            .timeline-marker {
                position: absolute;
                width: 2px;
                height: 100%;
                background: var(--border);
            }

            .timeline-marker-label {
                position: absolute;
                top: -20px;
                left: -30px;
                font-size: 0.7rem;
                color: var(--text-secondary);
                white-space: nowrap;
            }

            /* Event Icons */
            .event-icon {
                font-size: 1rem;
                margin-right: 0.5rem;
                display: inline-block;
                line-height: 1;
            }

            /* Duration Display */
            .event-duration {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 0.25rem 0;
                font-size: 0.75rem;
                color: var(--text-secondary);
                font-weight: 600;
                margin: 0.25rem 0;
                letter-spacing: 0.02em;
            }

            /* Timeline Error Display */
            .timeline-error {
                display: flex;
                align-items: flex-start;
                gap: 0.5rem;
                margin-top: 0.5rem;
                padding: 0.625rem 0.75rem;
                background: rgba(239, 68, 68, 0.1);
                border: 1px solid rgba(239, 68, 68, 0.3);
                border-radius: 4px;
            }

            .timeline-error-icon {
                font-size: 1rem;
                flex-shrink: 0;
                line-height: 1;
            }

            .timeline-error-message {
                font-size: 0.8125rem; /* Slightly smaller */
                color: #dc2626;
                font-family: "Monaco", "Courier New", monospace;
                line-height: 1.5;
                word-break: break-word;
                white-space: pre-wrap;
            }

            /* Hover Tooltips */
            .timeline-item[data-tooltip]:hover::before {
                content: attr(data-tooltip);
                position: absolute;
                top: -65px;
                left: 1rem;
                transform: translateX(0);
                background: var(--bg-darker);
                color: var(--text-light);
                padding: 0.625rem 1rem;
                border-radius: 6px;
                font-size: 0.8125rem;
                white-space: nowrap;
                min-width: fit-content;
                max-width: calc(90vw - 2rem);
                text-align: center;
                opacity: 1;
                z-index: 1000;
                box-shadow:
                    0 8px 24px rgba(0, 0, 0, 0.5),
                    0 2px 8px rgba(0, 0, 0, 0.3);
                line-height: 1.4;
                font-weight: 500;
                border: 1px solid var(--border);
                pointer-events: none;
                overflow: visible;
            }

            .timeline-item[data-tooltip]:hover::after {
                content: "";
                position: absolute;
                top: -12px;
                left: 1rem;
                transform: translateX(0);
                border: 10px solid transparent;
                border-top-color: var(--bg-darker);
                z-index: 1000;
                pointer-events: none;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            }

            /* Action Buttons */
            .timeline-header-actions {
                margin-bottom: 0.75rem;
            }

            .timeline-actions {
                display: flex;
                gap: 0.5rem;
            }

            .action-btn {
                padding: 0.375rem 0.625rem;
                background: var(--bg-primary);
                border: 1px solid var(--border);
                border-radius: 4px;
                font-size: 0.8125rem; /* Slightly smaller */
                font-weight: 500;
                color: var(--text-secondary);
                cursor: pointer;
                transition: all 0.15s;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }

            .action-btn:hover {
                background: var(--bg-secondary);
                border-color: var(--accent-blue);
                color: var(--accent-blue);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
                transform: translateY(-1px);
            }

            .action-btn:active {
                transform: translateY(0) scale(0.98);
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            }

            /* Toast Notifications */
            .toast {
                position: fixed;
                top: -100px;
                right: 2rem;
                background: var(--bg-darker);
                color: var(--text-light);
                padding: 1rem 1.5rem;
                border-radius: 8px;
                font-size: 0.9rem;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                transition: top 0.3s ease;
                z-index: 10000;
            }

            .toast.show {
                top: 2rem;
            }

            .toast-success {
                background: #15803d;
            }

            .toast-error {
                background: #ef4444;
            }

            /* Proportional Timeline */
            .timeline-proportional {
                display: flex;
                align-items: center;
                gap: 2px;
                padding: 1.25rem 1rem;
                background: var(--bg-primary);
                border-radius: 6px;
                overflow-x: auto;
                position: relative;
                min-height: 120px; /* Reduced height */
            }

            .timeline-segment-wrapper {
                position: relative;
                flex-shrink: 0;
                margin-right: 4px;
            }

            .timeline-segment {
                height: 48px;
                border-radius: 4px;
                position: relative;
                transition: all 0.2s ease;
                cursor: pointer;
            }

            .timeline-segment-marker {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 6px;
                background: rgba(255, 255, 255, 0.9);
                border-radius: 6px;
                box-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
            }

            .timeline-segment-label {
                position: absolute;
                left: 0;
                font-size: 0.6875rem;
                font-weight: 500;
                color: var(--text-primary);
                white-space: nowrap;
                max-width: 120px;
                overflow: hidden;
                text-overflow: ellipsis;
                background: var(--bg-secondary);
                padding: 0.1875rem 0.375rem;
                border-radius: 3px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
            }

            .timeline-segment-label.top {
                top: -28px;
            }

            .timeline-segment-label.bottom {
                bottom: -28px;
            }

            .timeline-segment-duration {
                position: absolute;
                bottom: -38px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 0.625rem;
                color: #6b7280;
                font-weight: 500;
                white-space: nowrap;
            }

            .timeline-segment.waiting {
                background: repeating-linear-gradient(
                    45deg,
                    #e5e7eb,
                    #e5e7eb 10px,
                    #d1d5db 10px,
                    #d1d5db 20px
                );
            }

            .timeline-segment.processing {
                background: linear-gradient(90deg, #3b82f6, #2563eb);
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            }

            .timeline-segment.completed {
                background: linear-gradient(90deg, #15803d, #16a34a);
                box-shadow: 0 2px 8px rgba(21, 128, 61, 0.3);
            }

            .timeline-segment.failed {
                background: linear-gradient(90deg, #ef4444, #dc2626);
                box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
            }

            .timeline-segment:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            /* Visual Status Indicators */
            .timeline::before {
                display: none;
            }

            .timeline {
                position: relative;
                padding-left: 0;
            }

            .timeline-item::before {
                content: "";
                position: absolute;
                left: -12px;
                top: 1.25rem;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                border: 2px solid var(--bg-secondary);
                background: currentColor;
                z-index: 1;
                box-shadow: 0 0 0 2px var(--bg-primary);
            }

            /* Pulsing animation for active states */
            .timeline-item.Started::before,
            .timeline-item.Running::before {
                animation: pulse-ring 2s ease-in-out infinite;
            }

            @keyframes pulse-ring {
                0%,
                100% {
                    box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.8);
                    transform: scale(1);
                }
                50% {
                    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0);
                    transform: scale(1.05);
                }
            }

            /* Timeline Item */
            .timeline-item {
                position: relative;
                padding: 0.75rem 1rem;
                background: var(--bg-secondary);
                border-radius: 6px;
                border: 1px solid var(--border);
                border-left: 3px solid;
                transition: all 0.15s ease;
                box-shadow: none;
                margin-bottom: 0;
            }

            .timeline-item:hover {
                background: var(--accent-blue-light);
                border-left-width: 4px;
                transform: translateX(2px);
            }

            .timeline-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.875rem;
                margin-bottom: 0.375rem;
                gap: 0.75rem;
            }

            .timeline-type {
                font-weight: 600;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 0.5rem;
                letter-spacing: 0;
                font-size: 0.875rem;
            }

            .timeline-time {
                color: var(--text-secondary);
                font-size: 0.8125rem;
                font-family: "Monaco", "Courier New", monospace;
                font-weight: 500;
                white-space: nowrap;
            }

            .timeline-worker {
                font-size: 0.75rem;
                color: var(--text-secondary);
                font-weight: 500;
                margin-top: 0.375rem;
                padding-top: 0.375rem;
                border-top: 1px solid var(--border);
                margin-bottom: 0;
            }

            .error-section {
                background: rgba(239, 68, 68, 0.1);
                border: 1px solid rgba(239, 68, 68, 0.3);
                padding: 1rem 1.25rem;
                border-radius: 6px;
                margin-bottom: 1rem;
            }

            .error-section h3 {
                color: #f87171;
                margin-bottom: 0.5rem;
                font-size: 0.875rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .error-message {
                color: #fca5a5;
                font-family: "Monaco", "Courier New", monospace;
                font-size: 0.8125rem;
                line-height: 1.6;
            }

            .error-time {
                color: #6b7280;
                font-size: 0.8rem;
                margin-top: 0.5rem;
            }

            /* Input/Results Display */
            .data-display {
                background: var(--bg-dark);
                color: var(--text-light);
                padding: 1rem;
                border-radius: 6px;
                border: 1px solid var(--border);
                font-family: "Monaco", "Courier New", monospace;
                font-size: 0.85rem;
                overflow-x: auto;
                max-height: 400px;
                overflow-y: auto;
                position: relative;
            }

            .section-header-with-action {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.75rem;
            }

            .copy-btn {
                background: var(--accent-blue);
                color: white;
                border: none;
                padding: 0.375rem 0.75rem;
                border-radius: 6px;
                font-size: 0.8125rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.15s;
                display: inline-flex;
                align-items: center;
                gap: 0.4rem;
            }

            .copy-btn:hover {
                background: var(--accent-blue-hover);
            }

            .copy-btn.copied {
                background: #15803d;
            }

            .empty-data {
                color: var(--text-secondary);
                font-style: italic;
                text-align: center;
                padding: 2rem;
            }

            .loading {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 2rem;
                color: var(--text-secondary);
                background: var(--bg-secondary);
            }

            .spinner {
                border: 3px solid var(--border);
                border-top-color: var(--accent-blue);
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .empty-state {
                padding: 3rem 2rem;
                text-align: center;
                color: var(--text-secondary);
            }

            .refresh-btn {
                background: var(--accent-blue);
                color: white;
                border: none;
                padding: 0.5rem 1rem;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: background 0.2s;
            }

            .refresh-btn:hover {
                background: var(--accent-blue-hover);
            }

            .error-banner {
                background: rgba(239, 68, 68, 0.15);
                color: #f87171;
                padding: 1rem 1.5rem;
                border-radius: 6px;
                border: 1px solid rgba(239, 68, 68, 0.3);
                margin-bottom: 1rem;
            }

            /* Search Bar */
            .search-container {
                background: var(--bg-secondary);
                border-radius: 8px;
                padding: 0.875rem 1.25rem;
                box-shadow: var(--shadow);
                border: 1px solid var(--border);
                display: flex;
                gap: 0.625rem;
                flex-wrap: wrap;
                align-items: center;
            }

            .limit-group {
                display: flex;
                gap: 0.5rem;
                align-items: center;
                margin-left: auto;
                padding-left: 0.75rem;
                border-left: 1px solid var(--border);
            }

            .limit-label {
                font-size: 0.8125rem;
                color: var(--text-secondary);
                font-weight: 500;
                white-space: nowrap;
            }

            .limit-custom-input {
                width: 80px;
                padding: 0.5rem 0.75rem;
                border: 2px solid var(--border-color);
                border-radius: 8px;
                background: var(--bg-primary);
                color: var(--text-primary);
                font-size: 0.875rem;
                font-family: inherit;
                transition: border-color 0.2s;
                display: none;
            }

            .limit-custom-input:focus {
                outline: none;
                border-color: var(--accent-blue);
            }

            .limit-custom-input.visible {
                display: block;
            }

            .search-input {
                flex: 1;
                min-width: 250px;
                padding: 0.625rem 0.875rem;
                border: 1px solid var(--border);
                border-radius: 6px;
                font-size: 0.875rem;
                font-family: inherit;
                background: var(--bg-tertiary);
                color: var(--text-primary);
                transition: all 0.15s;
            }

            .search-input::placeholder {
                color: var(--text-tertiary);
            }

            .search-input:focus {
                outline: none;
                border-color: var(--accent-blue);
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
                background: var(--bg-secondary);
            }

            .filter-select {
                padding: 0.625rem 0.875rem;
                border: 1px solid var(--border);
                border-radius: 6px;
                font-size: 0.875rem;
                font-family: inherit;
                background: var(--bg-tertiary);
                color: var(--text-primary);
                cursor: pointer;
                transition: all 0.15s;
                min-width: 140px;
            }

            .filter-select:focus {
                outline: none;
                border-color: var(--accent-blue);
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
                background: var(--bg-secondary);
            }

            .clear-filters-btn {
                padding: 0.625rem 0.875rem;
                border: 1px solid var(--border);
                background: var(--bg-tertiary);
                color: var(--text-secondary);
                border-radius: 6px;
                font-size: 0.875rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.15s;
            }

            .clear-filters-btn:hover {
                background: var(--bg-tertiary);
                border-color: var(--border-hover);
                color: var(--text-primary);
            }

            /* Animations */
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                }
                to {
                    transform: translateX(0);
                }
            }

            @keyframes shimmer {
                0% {
                    background-position: -1000px 0;
                }
                100% {
                    background-position: 1000px 0;
                }
            }

            .fade-in {
                animation: fadeIn 0.3s ease;
            }

            .slide-in {
                animation: slideIn 0.3s ease;
            }

            /* Loading States */
            .skeleton {
                background: linear-gradient(
                    90deg,
                    var(--bg-tertiary) 25%,
                    var(--border) 50%,
                    var(--bg-tertiary) 75%
                );
                background-size: 2000px 100%;
                animation: shimmer 2s infinite;
                border-radius: 4px;
            }

            .skeleton-text {
                height: 1rem;
                margin-bottom: 0.5rem;
            }

            .skeleton-card {
                height: 100px;
                border-radius: 12px;
            }

            /* Empty States */
            .empty-state {
                padding: 3rem 2rem;
                text-align: center;
                color: var(--text-secondary);
            }

            .empty-state-icon {
                font-size: 2.5rem;
                opacity: 0.4;
                margin-bottom: 1rem;
            }

            .empty-state-title {
                font-size: 1.125rem;
                font-weight: 600;
                color: var(--text-primary);
                margin-bottom: 0.5rem;
            }

            .empty-state-description {
                font-size: 0.875rem;
                max-width: 400px;
                margin: 0 auto;
                color: var(--text-secondary);
            }

            /* Connection Status Indicator */
            .connection-status {
                position: fixed;
                bottom: 1rem;
                right: 1rem;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                font-size: 0.75rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                box-shadow: var(--shadow-lg);
                border: 1px solid rgba(255, 255, 255, 0.1);
                z-index: 1000;
                transition: all 0.3s;
                backdrop-filter: blur(10px);
            }

            .connection-status.connected {
                background: rgba(21, 128, 61, 0.9);
                color: white;
            }

            .connection-status.disconnected {
                background: rgba(239, 68, 68, 0.9);
                color: white;
            }

            .connection-status.connecting {
                background: rgba(245, 158, 11, 0.9);
                color: white;
            }

            .connection-status::before {
                content: "";
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: currentColor;
                animation: pulse 2s ease-in-out infinite;
            }

            /* Responsive Design */
            @media (max-width: 1200px) {
                .content-grid {
                    grid-template-columns: minmax(0, 2fr) minmax(320px, 1fr);
                }

                .detail-grid {
                    grid-template-columns: 1fr;
                }
            }

            @media (max-width: 1024px) {
                .app-main {
                    padding: 1.5rem;
                }

                .content-grid {
                    grid-template-columns: 1fr;
                    gap: 1rem;
                }

                .detail-panel {
                    position: static;
                    max-height: none;
                    max-height: 600px;
                    overflow-y: auto;
                }

                .stats-grid {
                    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                    gap: 0.75rem;
                }

                .priority-stats {
                    flex-direction: column;
                    align-items: flex-start;
                }

                .priority-items {
                    width: 100%;
                }

                .search-container {
                    flex-direction: column;
                    align-items: stretch;
                    padding: 1rem;
                }

                .search-input,
                .filter-select {
                    width: 100%;
                }

                .limit-group {
                    width: 100%;
                    margin-left: 0;
                }

                .activity-table th,
                .activity-table td {
                    padding: 0.75rem 1rem;
                    font-size: 0.85rem;
                }
            }

            @media (max-width: 768px) {
                .app-main {
                    padding: 1rem;
                    gap: 1rem;
                }

                .app-header {
                    padding: 1rem;
                }

                .activities {
                    max-height: calc(100vh - 320px);
                }

                .stats-grid {
                    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                }

                /* Responsive timeline improvements */
                .timeline-item {
                    padding: 1.25rem 1rem;
                }

                .timeline-proportional {
                    padding: 2rem 1rem;
                    min-height: 160px;
                }

                .timeline-segment-label {
                    font-size: 0.7rem;
                    max-width: 120px;
                }

                .timeline-controls {
                    flex-direction: column;
                    align-items: stretch;
                }

                .timeline-actions {
                    width: 100%;
                    justify-content: stretch;
                }

                .action-btn {
                    flex: 1;
                }

                .stats-value {
                    font-size: 1.5rem;
                }

                .tabs {
                    width: 100%;
                    justify-content: space-between;
                }

                .tabs {
                    width: 100%;
                }

                .tabs button {
                    flex: 1;
                    font-size: 0.75rem;
                    padding: 0.4rem 0.5rem;
                }

                .section-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 0.75rem;
                }

                .activity-table th:last-child,
                .activity-table td:last-child {
                    display: none;
                }

                .detail-panel {
                    padding: 1rem;
                    max-height: 500px;
                }

                .detail-grid {
                    gap: 0.75rem;
                }

                .timeline-bar {
                    font-size: 0.7rem;
                    padding: 0 0.5rem;
                }
            }

            @media (max-width: 480px) {
                .app-header h1 {
                    font-size: 1.25rem;
                }

                .subtitle {
                    font-size: 0.8rem;
                }

                .worker-info {
                    font-size: 0.85rem;
                    padding: 0.4rem 0.75rem;
                }

                .stats-grid {
                    grid-template-columns: repeat(2, 1fr);
                }

                .search-container {
                    gap: 0.75rem;
                }

                .limit-group {
                    flex-wrap: wrap;
                }

                .limit-custom-input {
                    width: 100%;
                }

                .activities {
                    max-height: calc(100vh - 360px);
                }

                .activity-id {
                    font-size: 0.7rem;
                    word-break: break-all;
                }

                .timeline-item {
                    padding: 1rem;
                }

                .timeline-proportional {
                    padding: 1.5rem 0.75rem;
                    min-height: 140px;
                }

                .timeline-segment {
                    height: 60px;
                }

                .timeline-segment-label {
                    font-size: 0.65rem;
                    max-width: 100px;
                }

                .event-duration {
                    padding: 0.75rem 0;
                    font-size: 0.75rem;
                }
            }
        </style>
        <script>
            // Set theme immediately to prevent flash
            (function () {
                const theme = localStorage.getItem("theme") || "dark";
                document.documentElement.setAttribute("data-theme", theme);
            })();
        </script>
    </head>
    <body>
        <div class="app-shell">
            <header class="app-header">
                <div class="logo">R</div>
                <div class="header-content">
                    <h1>RunnerQ Console</h1>
                    <p class="subtitle">
                        Operational visibility for the RunnerQ worker fleet
                    </p>
                </div>
                <div
                    style="
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        margin-left: auto;
                    "
                >
                    <div
                        class="worker-info"
                        id="worker-info"
                        style="display: none"
                    >
                        <span class="worker-info-label">Workers:</span>
                        <span class="worker-info-value" id="worker-count"
                            >-</span
                        >
                    </div>
                    <button
                        class="theme-toggle"
                        id="theme-toggle"
                        title="Toggle theme"
                    >
                        <span class="theme-toggle-icon" id="theme-icon"
                            >☀️</span
                        >
                    </button>
                </div>
            </header>

            <main class="app-main">
                <div id="error-container"></div>

                <!-- Search and Filters -->
                <div class="search-container">
                    <input
                        type="text"
                        class="search-input"
                        id="search-input"
                        placeholder="🔍 Search by Activity ID or Type..."
                    />
                    <select class="filter-select" id="filter-type">
                        <option value="">All Activity Types</option>
                    </select>
                    <button class="clear-filters-btn" id="clear-filters">
                        Clear Filters
                    </button>
                    <div class="limit-group">
                        <span class="limit-label">Show:</span>
                        <select
                            class="filter-select"
                            id="limit-select"
                            style="width: auto; min-width: 100px"
                        >
                            <option value="10">10</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="custom">Custom</option>
                        </select>
                        <input
                            type="number"
                            class="limit-custom-input"
                            id="limit-custom-input"
                            placeholder="Enter limit"
                            min="1"
                            max="1000"
                        />
                    </div>
                </div>

                <!-- Stats Overview -->
                <div class="stats-grid" id="stats-grid">
                    <div class="stats-card pending">
                        <div class="stats-header">
                            <span class="stats-label">Pending</span>
                            <span class="stats-trend" id="trend-pending"></span>
                        </div>
                        <span class="stats-value" id="stat-pending">-</span>
                        <div class="stats-bar">
                            <div
                                class="stats-bar-fill"
                                id="bar-pending"
                                style="width: 0%"
                            ></div>
                        </div>
                    </div>
                    <div class="stats-card processing">
                        <div class="stats-header">
                            <span class="stats-label">Processing</span>
                            <span
                                class="stats-trend"
                                id="trend-processing"
                            ></span>
                        </div>
                        <span class="stats-value" id="stat-processing">-</span>
                        <div class="stats-bar">
                            <div
                                class="stats-bar-fill"
                                id="bar-processing"
                                style="width: 0%"
                            ></div>
                        </div>
                    </div>
                    <div class="stats-card scheduled">
                        <div class="stats-header">
                            <span class="stats-label">Scheduled</span>
                            <span
                                class="stats-trend"
                                id="trend-scheduled"
                            ></span>
                        </div>
                        <span class="stats-value" id="stat-scheduled">-</span>
                        <div class="stats-bar">
                            <div
                                class="stats-bar-fill"
                                id="bar-scheduled"
                                style="width: 0%"
                            ></div>
                        </div>
                    </div>
                    <div class="stats-card dead-letter">
                        <div class="stats-header">
                            <span class="stats-label">Dead Letter</span>
                            <span
                                class="stats-trend"
                                id="trend-dead-letter"
                            ></span>
                        </div>
                        <span class="stats-value" id="stat-dead-letter">-</span>
                        <div class="stats-bar">
                            <div
                                class="stats-bar-fill"
                                id="bar-dead-letter"
                                style="width: 0%"
                            ></div>
                        </div>
                    </div>
                </div>

                <!-- Priority Distribution -->
                <div class="priority-stats">
                    <div class="priority-stats-title">
                        Priority Distribution
                    </div>
                    <div class="priority-items">
                        <div class="priority-item">
                            <div class="priority-dot critical"></div>
                            <span class="priority-item-label">Critical</span>
                            <span class="priority-item-value" id="stat-critical"
                                >-</span
                            >
                        </div>
                        <div class="priority-item">
                            <div class="priority-dot high"></div>
                            <span class="priority-item-label">High</span>
                            <span class="priority-item-value" id="stat-high"
                                >-</span
                            >
                        </div>
                        <div class="priority-item">
                            <div class="priority-dot normal"></div>
                            <span class="priority-item-label">Normal</span>
                            <span class="priority-item-value" id="stat-normal"
                                >-</span
                            >
                        </div>
                        <div class="priority-item">
                            <div class="priority-dot low"></div>
                            <span class="priority-item-label">Low</span>
                            <span class="priority-item-value" id="stat-low"
                                >-</span
                            >
                        </div>
                    </div>
                </div>

                <!-- Content Grid -->
                <div class="content-grid">
                    <!-- Activities Table -->
                    <section class="activities">
                        <div class="section-header">
                            <nav class="tabs">
                                <button
                                    class="active"
                                    data-collection="processing"
                                >
                                    Processing
                                </button>
                                <button data-collection="pending">
                                    Pending
                                </button>
                                <button data-collection="completed">
                                    Completed
                                </button>
                                <button data-collection="scheduled">
                                    Scheduled
                                </button>
                                <button data-collection="dead_letter">
                                    Dead Letter
                                </button>
                            </nav>
                            <span class="collection-count" id="collection-count"
                                >0 items</span
                            >
                        </div>

                        <div id="activity-table-container">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </section>

                    <!-- Activity Detail Panel -->
                    <aside class="detail-panel empty" id="detail-panel">
                        <p>Select an activity to inspect its details</p>
                    </aside>
                </div>
            </main>

            <!-- Connection Status Indicator -->
            <div id="connection-status" class="connection-status connecting">
                Connecting...
            </div>
        </div>

        <script>
            // Configuration
            // Auto-detect the API base relative to the current page
            const getApiBase = () => {
                if (window.RUNNERQ_API_BASE) return window.RUNNERQ_API_BASE;
                // Get the current path and construct relative API path
                const currentPath = window.location.pathname.replace(/\/$/, "");
                return `${currentPath}/api/observability`;
            };
            const API_BASE = getApiBase();

            // State
            let currentCollection = "processing";
            let selectedActivityId = null;
            let activities = [];
            let filteredActivities = [];
            let allActivityTypes = new Set();
            let eventSource = null;
            let reconnectTimer = null;
            let searchTerm = "";
            let filterType = "";
            let sortColumn = "created_at";
            let sortDirection = "desc";
            let activityLimit = parseInt(
                localStorage.getItem("runnerq_activity_limit") || "50",
                10,
            );

            // Utility Functions
            const formatDate = (isoString) => {
                if (!isoString) return "—";
                return new Date(isoString).toLocaleString();
            };

            const fetchJSON = async (url) => {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            };

            const showError = (message) => {
                const container = document.getElementById("error-container");
                container.innerHTML = `
                <div class="error-banner">
                    <strong>Error:</strong> ${escapeHtml(message)}
                    <button class="refresh-btn" onclick="location.reload()">Reload</button>
                </div>
            `;
            };

            // Data Fetching
            let previousStats = {};

            const loadStats = async () => {
                try {
                    const stats = await fetchJSON(`${API_BASE}/stats`);
                    // Priority counts are part of pending_activities, not separate
                    const totalActivities =
                        stats.pending_activities +
                        stats.processing_activities +
                        stats.scheduled_activities +
                        stats.dead_letter_activities;

                    updateStatCard(
                        "pending",
                        stats.pending_activities || 0,
                        totalActivities,
                    );
                    updateStatCard(
                        "processing",
                        stats.processing_activities || 0,
                        totalActivities,
                    );
                    updateStatCard(
                        "scheduled",
                        stats.scheduled_activities || 0,
                        totalActivities,
                    );
                    updateStatCard(
                        "dead-letter",
                        stats.dead_letter_activities || 0,
                        totalActivities,
                    );

                    // Update priority distribution (no bars/trends for these)
                    updatePriorityItem(
                        "critical",
                        stats.critical_priority || 0,
                    );
                    updatePriorityItem("high", stats.high_priority || 0);
                    updatePriorityItem("normal", stats.normal_priority || 0);
                    updatePriorityItem("low", stats.low_priority || 0);

                    // Update worker count if available
                    if (
                        stats.max_workers !== undefined &&
                        stats.max_workers !== null
                    ) {
                        const workerInfo =
                            document.getElementById("worker-info");
                        const workerCount =
                            document.getElementById("worker-count");
                        if (workerInfo && workerCount) {
                            workerCount.textContent = stats.max_workers;
                            workerInfo.style.display = "flex";
                        }
                    }

                    previousStats = stats;
                } catch (error) {
                    console.error("Failed to load stats:", error);
                    showError("Failed to load queue statistics");
                }
            };

            const updatePriorityItem = (id, value) => {
                const valueEl = document.getElementById(`stat-${id}`);
                if (valueEl) {
                    valueEl.textContent = value;
                }
            };

            const updateStatCard = (id, value, total) => {
                const valueEl = document.getElementById(`stat-${id}`);

                if (!valueEl) return;

                // Update value
                valueEl.textContent = value;

                // Only update bars and trends for main cards (not priority items)
                const barEl = document.getElementById(`bar-${id}`);
                const trendEl = document.getElementById(`trend-${id}`);

                // Update progress bar (percentage of total)
                if (barEl && total > 0) {
                    const percentage = Math.min((value / total) * 100, 100);
                    barEl.style.width = `${percentage}%`;
                }

                // Update trend (if we have previous data)
                if (trendEl && previousStats[id] !== undefined) {
                    const prev = previousStats[id] || 0;
                    const diff = value - prev;

                    if (diff > 0) {
                        trendEl.className = "stats-trend up";
                        trendEl.textContent = `↑ ${diff}`;
                    } else if (diff < 0) {
                        trendEl.className = "stats-trend down";
                        trendEl.textContent = `↓ ${Math.abs(diff)}`;
                    } else {
                        trendEl.className = "stats-trend";
                        trendEl.textContent = "";
                    }
                }
            };

            const filterByPriority = (priority) => {
                // For priority, we need to switch to the right collection and search
                switchCollection("pending");
                // Note: We don't have a priority filter in the UI, but we can use search
                const searchInput = document.getElementById("search-input");
                if (searchInput) {
                    searchInput.value = "";
                    searchTerm = "";
                }
                // Apply filters to refresh
                setTimeout(() => applyFilters(), 100);
            };

            const showLoadingSkeleton = () => {
                const container = document.getElementById(
                    "activity-table-container",
                );
                const bgColor = getComputedStyle(document.documentElement)
                    .getPropertyValue("--bg-secondary")
                    .trim();
                container.innerHTML = `
                <div style="padding: 2rem; background: ${bgColor};">
                    <div class="skeleton skeleton-card" style="margin-bottom: 1rem;"></div>
                    <div class="skeleton skeleton-card" style="margin-bottom: 1rem;"></div>
                    <div class="skeleton skeleton-card"></div>
                </div>
            `;
            };

            const loadActivities = async (collection) => {
                try {
                    showLoadingSkeleton();

                    const data = await fetchJSON(
                        `${API_BASE}/activities/${collection}?limit=${activityLimit}`,
                    );
                    activities = data;

                    // Update activity types for filter dropdown
                    data.forEach((activity) =>
                        allActivityTypes.add(activity.activity_type),
                    );
                    updateActivityTypeFilter();

                    // Apply filters
                    applyFilters();
                } catch (error) {
                    console.error("Failed to load activities:", error);
                    document.getElementById(
                        "activity-table-container",
                    ).innerHTML = `
                    <div class="empty-state fade-in">
                        <div class="empty-state-icon">⚠️</div>
                        <div class="empty-state-title">Failed to load activities</div>
                        <div class="empty-state-description">
                            ${error.message || "An error occurred while loading activities"}
                        </div>
                    </div>
                `;
                }
            };

            const updateActivityTypeFilter = () => {
                const typeFilter = document.getElementById("filter-type");
                const currentValue = typeFilter.value;

                typeFilter.innerHTML =
                    '<option value="">All Activity Types</option>';
                Array.from(allActivityTypes)
                    .sort()
                    .forEach((type) => {
                        const option = document.createElement("option");
                        option.value = type;
                        option.textContent = type;
                        typeFilter.appendChild(option);
                    });

                // Restore selection if it still exists
                if (currentValue && allActivityTypes.has(currentValue)) {
                    typeFilter.value = currentValue;
                }
            };

            const applyFilters = () => {
                filteredActivities = activities.filter((activity) => {
                    // Search term filter
                    if (searchTerm) {
                        const term = searchTerm.toLowerCase();
                        const matchesId = activity.id
                            .toLowerCase()
                            .includes(term);
                        const matchesType = activity.activity_type
                            .toLowerCase()
                            .includes(term);
                        if (!matchesId && !matchesType) return false;
                    }

                    // Type filter
                    if (filterType && activity.activity_type !== filterType) {
                        return false;
                    }

                    return true;
                });

                // Apply sorting
                applySorting();

                renderActivityTable(filteredActivities);

                // Update count
                document.getElementById("collection-count").textContent =
                    `${filteredActivities.length} of ${activities.length} item${activities.length !== 1 ? "s" : ""}`;

                // Auto-select first activity if none selected
                if (filteredActivities.length > 0 && !selectedActivityId) {
                    selectActivity(filteredActivities[0].id);
                } else if (filteredActivities.length === 0) {
                    clearDetailPanel();
                } else if (
                    selectedActivityId &&
                    !filteredActivities.find((a) => a.id === selectedActivityId)
                ) {
                    // Selected activity no longer in filtered list
                    clearDetailPanel();
                }
            };

            const applySorting = () => {
                filteredActivities.sort((a, b) => {
                    let aVal, bVal;

                    switch (sortColumn) {
                        case "activity_type":
                            aVal = a.activity_type || "";
                            bVal = b.activity_type || "";
                            break;
                        case "priority":
                            const priorityOrder = {
                                Critical: 0,
                                High: 1,
                                Normal: 2,
                                Low: 3,
                            };
                            aVal = priorityOrder[a.priority] ?? 999;
                            bVal = priorityOrder[b.priority] ?? 999;
                            break;
                        case "status":
                            aVal = a.status || "";
                            bVal = b.status || "";
                            break;
                        case "created_at":
                        default:
                            aVal = new Date(a.created_at || 0);
                            bVal = new Date(b.created_at || 0);
                    }

                    if (aVal < bVal) return sortDirection === "asc" ? -1 : 1;
                    if (aVal > bVal) return sortDirection === "asc" ? 1 : -1;
                    return 0;
                });
            };

            const sortBy = (column) => {
                if (sortColumn === column) {
                    sortDirection = sortDirection === "asc" ? "desc" : "asc";
                } else {
                    sortColumn = column;
                    sortDirection = "asc";
                }
                applyFilters();
            };

            const loadActivityDetail = async (activityId) => {
                try {
                    const [activity, events, result] = await Promise.all([
                        fetchJSON(`${API_BASE}/activities/${activityId}`),
                        fetchJSON(
                            `${API_BASE}/activities/${activityId}/events?limit=30`,
                        ),
                        fetchJSON(
                            `${API_BASE}/activities/${activityId}/result`,
                        ).catch(() => null),
                    ]);
                    renderDetailPanel(activity, events, result);
                } catch (error) {
                    console.error("Failed to load activity detail:", error);
                }
            };

            // Rendering Functions
            const renderActivityTable = (data) => {
                const container = document.getElementById(
                    "activity-table-container",
                );

                if (data.length === 0) {
                    let emptyMessage = "No activities found";
                    let emptyIcon = "📭";

                    if (searchTerm || filterType) {
                        emptyMessage = "No activities match your filters";
                        emptyIcon = "🔍";
                    } else if (currentCollection === "completed") {
                        emptyMessage = "No completed activities found";
                        emptyIcon = "✅";
                    } else if (currentCollection === "scheduled") {
                        emptyMessage = "No scheduled activities";
                        emptyIcon = "📅";
                    } else if (currentCollection === "dead_letter") {
                        emptyMessage = "No activities in dead letter queue";
                        emptyIcon = "✨";
                    }

                    let emptyDescription =
                        searchTerm || filterType
                            ? "Try adjusting your search or filter criteria"
                            : currentCollection === "scheduled"
                              ? "Activities scheduled for future execution will appear here"
                              : "Activities will appear here when they are enqueued";

                    container.innerHTML = `
                    <div class="empty-state fade-in">
                        <div class="empty-state-icon">${emptyIcon}</div>
                        <div class="empty-state-title">${emptyMessage}</div>
                        <div class="empty-state-description">
                            ${emptyDescription}
                        </div>
                    </div>
                `;
                    return;
                }

                const rows = data
                    .map(
                        (activity) => `
                <tr class="${selectedActivityId === activity.id ? "selected" : ""} fade-in"
                    data-activity-id="${escapeHtml(activity.id)}"
                    onclick="selectActivity(this.dataset.activityId)">
                    <td>
                        <div class="activity-type">${escapeHtml(activity.activity_type)}</div>
                        <div class="activity-id">${activity.id}</div>
                    </td>
                    <td>
                        <span class="priority ${activity.priority}">${activity.priority}</span>
                    </td>
                    <td>
                        <span class="status-badge ${activity.status}">${activity.status}</span>
                    </td>
                    <td>${formatDate(activity.created_at)}</td>
                    <td>${activity.current_worker_id || activity.last_worker_id || "—"}</td>
                </tr>
            `,
                    )
                    .join("");

                container.innerHTML = `
                <table class="activity-table">
                    <thead>
                        <tr>
                            <th class="sortable ${sortColumn === "activity_type" ? "sorted-" + sortDirection : ""}" onclick="sortBy('activity_type')">
                                Activity
                            </th>
                            <th class="sortable ${sortColumn === "priority" ? "sorted-" + sortDirection : ""}" onclick="sortBy('priority')">
                                Priority
                            </th>
                            <th class="sortable ${sortColumn === "status" ? "sorted-" + sortDirection : ""}" onclick="sortBy('status')">
                                Status
                            </th>
                            <th class="sortable ${sortColumn === "created_at" ? "sorted-" + sortDirection : ""}" onclick="sortBy('created_at')">
                                Created
                            </th>
                            <th>Worker</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
            };

            const renderDetailPanel = (activity, events, result) => {
                const panel = document.getElementById("detail-panel");
                panel.className = "detail-panel slide-in";

                // Input display
                // Input section - create DOM elements safely
                const inputData = activity.input || activity.payload || null;
                const createInputSection = () => {
                    const section = document.createElement("div");
                    if (inputData) {
                        const header = document.createElement("div");
                        header.className = "section-header-with-action";

                        const h3 = document.createElement("h3");
                        h3.textContent = "Input";

                        const copyBtn = document.createElement("button");
                        copyBtn.className = "copy-btn";
                        copyBtn.textContent = "📋 Copy";
                        copyBtn.onclick = function () {
                            copyToClipboard("input-" + activity.id, this);
                        };

                        header.appendChild(h3);
                        header.appendChild(copyBtn);

                        const pre = document.createElement("pre");
                        pre.className = "data-display";
                        pre.id = "input-" + activity.id;
                        pre.textContent = JSON.stringify(inputData, null, 2);

                        section.appendChild(header);
                        section.appendChild(pre);
                    } else {
                        const h3 = document.createElement("h3");
                        h3.textContent = "Input";
                        const emptyDiv = document.createElement("div");
                        emptyDiv.className = "empty-data";
                        emptyDiv.textContent = "No input data";
                        section.appendChild(h3);
                        section.appendChild(emptyDiv);
                    }
                    return section;
                };

                // Results section - create DOM elements safely
                const resultData =
                    result?.data || activity.result || activity.output || null;
                const createResultSection = () => {
                    const section = document.createElement("div");
                    if (resultData) {
                        const header = document.createElement("div");
                        header.className = "section-header-with-action";

                        const h3 = document.createElement("h3");
                        h3.textContent = "Results";

                        const copyBtn = document.createElement("button");
                        copyBtn.className = "copy-btn";
                        copyBtn.textContent = "📋 Copy";
                        copyBtn.onclick = function () {
                            copyToClipboard("result-" + activity.id, this);
                        };

                        header.appendChild(h3);
                        header.appendChild(copyBtn);

                        const pre = document.createElement("pre");
                        pre.className = "data-display";
                        pre.id = "result-" + activity.id;
                        pre.textContent = JSON.stringify(resultData, null, 2);

                        section.appendChild(header);
                        section.appendChild(pre);
                    } else {
                        const h3 = document.createElement("h3");
                        h3.textContent = "Results";
                        const emptyDiv = document.createElement("div");
                        emptyDiv.className = "empty-data";
                        emptyDiv.textContent = "No results yet";
                        section.appendChild(h3);
                        section.appendChild(emptyDiv);
                    }
                    return section;
                };

                const metadataHtml =
                    Object.keys(activity.metadata || {}).length > 0
                        ? `<ul class="metadata-list">
                    ${Object.entries(activity.metadata)
                        .map(
                            ([key, value]) => `
                        <li class="metadata-item">
                            <span class="metadata-key">${escapeHtml(key)}</span>
                            <span class="metadata-value">${escapeHtml(value)}</span>
                        </li>
                    `,
                        )
                        .join("")}
                   </ul>`
                        : '<p style="color: var(--text-secondary)">No metadata</p>';

                // Build timeline HTML with view toggle
                const eventsHtml =
                    events && events.length > 0
                        ? `<div class="timeline-header-actions">
                    <div class="timeline-controls">
                        <div class="view-toggle">
                            <button onclick="setTimelineView('${activity.id}', 'compact')" class="timeline-view-btn active" data-view="compact">Compact</button>
                            <button onclick="setTimelineView('${activity.id}', 'visual')" class="timeline-view-btn" data-view="visual">Timeline</button>
                            <button onclick="setTimelineView('${activity.id}', 'detailed')" class="timeline-view-btn" data-view="detailed">Detailed</button>
                        </div>
                        <div class="timeline-actions">
                            <button onclick="copyEventHistory('${activity.id}')"
                                    class="action-btn" title="Copy event history">
                                📋 Copy
                            </button>
                            <button onclick="exportEventHistory('${activity.id}')"
                                    class="action-btn" title="Export as JSON">
                                📥 Export
                            </button>
                        </div>
                    </div>
                   </div>
                   <div id="timeline-${activity.id}" data-activity='${JSON.stringify(activity).replace(/'/g, "&apos;")}'>
                    ${renderTimelineView(events, "compact", activity)}
                   </div>`
                        : '<p style="color: var(--text-secondary)">No events recorded</p>';

                const errorHtml = activity.last_error
                    ? `<div class="error-section">
                    <h3>Last Error</h3>
                    <div class="error-message">${escapeHtml(activity.last_error)}</div>
                    <div class="error-time">${formatDate(activity.last_error_at)}</div>
                   </div>`
                    : "";

                // Calculate duration if available
                let duration = "—";
                if (activity.started_at && activity.completed_at) {
                    const start = new Date(activity.started_at);
                    const end = new Date(activity.completed_at);
                    const ms = end - start;
                    const seconds = Math.floor(ms / 1000);
                    const milliseconds = ms % 1000;
                    duration = `${seconds}s ${milliseconds}ms`;
                } else if (activity.started_at) {
                    const start = new Date(activity.started_at);
                    const now = new Date();
                    const ms = now - start;
                    const seconds = Math.floor(ms / 1000);
                    duration = `${seconds}s (running)`;
                }

                panel.innerHTML = `
                <div class="detail-header">
                    <div>
                        <h2>${escapeHtml(activity.activity_type)}</h2>
                        <div class="activity-id">${activity.id}</div>
                    </div>
                    <button class="close-btn" onclick="clearDetailPanel()">✕</button>
                </div>

                <div class="detail-section">
                    <h3>Overview</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">Status</span>
                            <span class="detail-value">
                                <span class="status-badge ${activity.status}">${activity.status}</span>
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Priority</span>
                            <span class="detail-value">
                                <span class="priority ${activity.priority}">${activity.priority}</span>
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Duration</span>
                            <span class="detail-value">${duration}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">State Transitions</span>
                            <span class="detail-value">${events ? events.length : 0}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Worker</span>
                            <span class="detail-value">${activity.current_worker_id || activity.last_worker_id || "—"}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Queue</span>
                            <span class="detail-value">${activity.queue_name || "—"}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Retries</span>
                            <span class="detail-value">${activity.retry_count} / ${activity.max_retries || "∞"}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Timeout</span>
                            <span class="detail-value">${activity.timeout_seconds}s</span>
                        </div>
                        ${
                            activity.idempotency_key
                                ? `
                        <div class="detail-item">
                            <span class="detail-label">Idempotency Key</span>
                            <span class="detail-value">
                                <code style="background: var(--bg-tertiary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem;">${escapeHtml(activity.idempotency_key)}</code>
                            </span>
                        </div>
                        `
                                : ""
                        }
                    </div>
                </div>

                ${errorHtml}

                <div class="detail-section" id="input-section-container"></div>

                <div class="detail-section" id="result-section-container"></div>

                <div class="detail-section">
                    <h3>Metadata</h3>
                    ${metadataHtml}
                </div>

                <div class="detail-section">
                    <h3>Event History</h3>
                    ${eventsHtml}
                </div>
            `;

                // Safely append input and result sections using DOM APIs
                const inputContainer = document.getElementById(
                    "input-section-container",
                );
                const resultContainer = document.getElementById(
                    "result-section-container",
                );

                if (inputContainer) {
                    const inputSection = createInputSection();
                    inputContainer.appendChild(inputSection);
                }

                if (resultContainer) {
                    const resultSection = createResultSection();
                    resultContainer.appendChild(resultSection);
                }
            };

            const clearDetailPanel = () => {
                selectedActivityId = null;
                const panel = document.getElementById("detail-panel");
                panel.className = "detail-panel empty";
                panel.innerHTML =
                    "<p>Select an activity to inspect its details</p>";
                renderActivityTable(filteredActivities);
            };

            const escapeHtml = (text) => {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            };

            // Helper functions for Event History enhancements
            const getEventIcon = (eventType) => {
                const icons = {
                    Enqueued: "📥",
                    Dequeued: "⚡",
                    Started: "▶️",
                    Running: "▶️",
                    Completed: "✅",
                    Failed: "❌",
                    Retrying: "🔄",
                    Scheduled: "📅",
                    LeaseExtended: "💓",
                    DeadLetter: "⚰️",
                    ResultStored: "💾",
                };
                return icons[eventType] || "•";
            };

            const calculateDuration = (timestamp1, timestamp2) => {
                const ms = new Date(timestamp2) - new Date(timestamp1);
                if (ms < 1000) return `${ms}ms`;
                if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
                if (ms < 3600000)
                    return `${Math.floor(ms / 60000)}m ${Math.floor((ms % 60000) / 1000)}s`;
                return `${Math.floor(ms / 3600000)}h ${Math.floor((ms % 3600000) / 60000)}m`;
            };

            const copyEventHistory = async (activityId) => {
                try {
                    const events = await fetchJSON(
                        `${API_BASE}/activities/${activityId}/events?limit=100`,
                    );
                    const formatted = events
                        .map(
                            (e) =>
                                `${e.event_type.padEnd(15)} ${formatDate(e.timestamp)}${e.worker_id ? "  Worker: " + e.worker_id : ""}`,
                        )
                        .join("\n");

                    await navigator.clipboard.writeText(formatted);
                    showToast("Event history copied to clipboard", "success");
                } catch (err) {
                    console.error("Failed to copy:", err);
                    showToast("Failed to copy event history", "error");
                }
            };

            const exportEventHistory = async (activityId) => {
                try {
                    const events = await fetchJSON(
                        `${API_BASE}/activities/${activityId}/events?limit=100`,
                    );
                    const blob = new Blob([JSON.stringify(events, null, 2)], {
                        type: "application/json",
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `activity-${activityId}-events.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast("Event history exported", "success");
                } catch (err) {
                    console.error("Failed to export:", err);
                    showToast("Failed to export event history", "error");
                }
            };

            const showToast = (message, type = "info") => {
                const toast = document.createElement("div");
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => toast.classList.add("show"), 100);
                setTimeout(() => {
                    toast.classList.remove("show");
                    setTimeout(() => document.body.removeChild(toast), 300);
                }, 3000);
            };

            const renderTimelineView = (events, viewMode, activity = null) => {
                if (viewMode === "compact") {
                    // Compact list view with durations and enhanced features
                    return `<ol class="timeline">
                    ${events
                        .map((event, idx) => {
                            const prevEvent = events[idx - 1];
                            const duration = prevEvent
                                ? calculateDuration(
                                      prevEvent.timestamp,
                                      event.timestamp,
                                  )
                                : null;
                            const errorMessage =
                                event.event_type === "Failed" &&
                                activity?.last_error
                                    ? activity.last_error
                                    : null;

                            return `
                            ${duration ? `<div class="event-duration">↓ ${duration}</div>` : ""}
                            <li class="timeline-item ${event.event_type}"
                                data-tooltip="${escapeHtml(event.event_type)} at ${formatDate(event.timestamp)}">
                                <div class="timeline-header">
                                    <span class="timeline-type">
                                        <span class="event-icon">${getEventIcon(event.event_type)}</span>
                                        ${escapeHtml(event.event_type)}
                                    </span>
                                    <span class="timeline-time">${formatRelativeTime(event.timestamp)}</span>
                                </div>
                                ${event.worker_id ? `<div class="timeline-worker">Worker: ${escapeHtml(event.worker_id)}</div>` : ""}
                                ${
                                    errorMessage
                                        ? `
                                    <div class="timeline-error">
                                        <div class="timeline-error-icon">⚠️</div>
                                        <div class="timeline-error-message">${escapeHtml(errorMessage)}</div>
                                    </div>
                                `
                                        : ""
                                }
                            </li>
                        `;
                        })
                        .join("")}
                </ol>`;
                } else if (viewMode === "visual") {
                    // Enhanced proportional timeline view with alternating labels
                    const firstEvent = events[0];
                    const lastEvent = events[events.length - 1];
                    const totalDuration =
                        new Date(lastEvent.timestamp) -
                        new Date(firstEvent.timestamp);

                    const minWidth = 120; // Increased from 80px
                    const maxWidth = 500; // Increased from 400px

                    return `<div class="timeline-proportional">
                    ${events
                        .map((event, idx) => {
                            const nextEvent = events[idx + 1];
                            const duration = nextEvent
                                ? new Date(nextEvent.timestamp) -
                                  new Date(event.timestamp)
                                : 0;

                            // Calculate proportional width
                            const percentage =
                                totalDuration > 0
                                    ? (duration / totalDuration) * 100
                                    : 0;
                            const width = Math.max(
                                minWidth,
                                Math.min(maxWidth, percentage * 5),
                            );

                            let segmentClass = "waiting";
                            if (
                                event.event_type === "Started" ||
                                event.event_type === "Running" ||
                                event.event_type === "Dequeued"
                            ) {
                                segmentClass = "processing";
                            } else if (event.event_type === "Completed") {
                                segmentClass = "completed";
                            } else if (event.event_type === "Failed") {
                                segmentClass = "failed";
                            }

                            // Alternate label positions: even = top, odd = bottom
                            const labelPosition =
                                idx % 2 === 0 ? "top" : "bottom";

                            return `
                        <div class="timeline-segment-wrapper" style="width: ${width}px;">
                            <div class="timeline-segment ${segmentClass}"
                                 title="${escapeHtml(event.event_type)} at ${formatDate(event.timestamp)}${duration > 0 ? " - Duration: " + calculateDuration(event.timestamp, nextEvent.timestamp) : ""}">
                                <div class="timeline-segment-marker"></div>
                                <div class="timeline-segment-label ${labelPosition}">
                                    ${getEventIcon(event.event_type)} ${escapeHtml(event.event_type)}
                                </div>
                                ${duration > 0 ? `<div class="timeline-segment-duration">${calculateDuration(event.timestamp, nextEvent.timestamp)}</div>` : ""}
                            </div>
                        </div>
                        `;
                        })
                        .join("")}
                </div>`;
                } else {
                    // Detailed view with all info
                    return `<ol class="timeline">
                    ${events
                        .map((event, idx) => {
                            const prevEvent = events[idx - 1];
                            const duration = prevEvent
                                ? calculateDuration(
                                      prevEvent.timestamp,
                                      event.timestamp,
                                  )
                                : null;
                            const errorMessage =
                                event.event_type === "Failed" &&
                                activity?.last_error
                                    ? activity.last_error
                                    : null;

                            return `
                            ${duration ? `<div class="event-duration">↓ ${duration}</div>` : ""}
                            <li class="timeline-item ${event.event_type}"
                                data-tooltip="${escapeHtml(event.event_type)} at ${formatDate(event.timestamp)}">
                                <div class="timeline-header">
                                    <span class="timeline-type">
                                        <span class="event-icon">${getEventIcon(event.event_type)}</span>
                                        ${escapeHtml(event.event_type)}
                                    </span>
                                    <span class="timeline-time">${formatDate(event.timestamp)}</span>
                                </div>
                                ${event.worker_id ? `<div class="timeline-worker">Worker: ${escapeHtml(event.worker_id)}</div>` : ""}
                                ${event.detail ? `<pre class="timeline-detail">${escapeHtml(JSON.stringify(event.detail, null, 2))}</pre>` : ""}
                                ${
                                    errorMessage
                                        ? `
                                    <div class="timeline-error">
                                        <div class="timeline-error-icon">⚠️</div>
                                        <div class="timeline-error-message">${escapeHtml(errorMessage)}</div>
                                    </div>
                                `
                                        : ""
                                }
                            </li>
                        `;
                        })
                        .join("")}
                </ol>`;
                }
            };

            const formatRelativeTime = (isoString) => {
                if (!isoString) return "—";
                const date = new Date(isoString);
                const now = new Date();
                const diffMs = now - date;
                const diffSecs = Math.floor(diffMs / 1000);
                const diffMins = Math.floor(diffSecs / 60);
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);

                if (diffSecs < 60) return `${diffSecs}s ago`;
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                return `${diffDays}d ago`;
            };

            const setTimelineView = async (activityId, viewMode) => {
                const timelineContainer = document.getElementById(
                    `timeline-${activityId}`,
                );
                if (!timelineContainer) return;

                // Update active button
                document
                    .querySelectorAll(".timeline-view-btn")
                    .forEach((btn) => {
                        btn.classList.toggle(
                            "active",
                            btn.dataset.view === viewMode,
                        );
                    });

                // Get activity and events data
                try {
                    const activityData = timelineContainer.dataset.activity;
                    const activity = activityData
                        ? JSON.parse(activityData)
                        : null;
                    const events = await fetchJSON(
                        `${API_BASE}/activities/${activityId}/events?limit=30`,
                    );

                    // Re-render with new view mode
                    timelineContainer.innerHTML = renderTimelineView(
                        events,
                        viewMode,
                        activity,
                    );
                } catch (err) {
                    console.error("Failed to switch timeline view:", err);
                }
            };

            // Event Handlers
            const selectActivity = (activityId) => {
                selectedActivityId = activityId;

                // Update selected state without re-rendering entire table
                document
                    .querySelectorAll(".activity-table tbody tr")
                    .forEach((row) => {
                        if (row.dataset.activityId === activityId) {
                            row.classList.add("selected");
                        } else {
                            row.classList.remove("selected");
                        }
                    });

                loadActivityDetail(activityId);
            };

            const switchCollection = (collection) => {
                currentCollection = collection;
                selectedActivityId = null;

                // Update tabs
                document.querySelectorAll(".tabs button").forEach((btn) => {
                    btn.classList.toggle(
                        "active",
                        btn.dataset.collection === collection,
                    );
                });

                loadActivities(collection);
            };

            // Connection status management
            const updateConnectionStatus = (status, message) => {
                const statusEl = document.getElementById("connection-status");
                if (!statusEl) return;

                statusEl.className = `connection-status ${status}`;
                statusEl.textContent = message;

                // Auto-hide connected status after 3 seconds
                if (status === "connected") {
                    setTimeout(() => {
                        statusEl.style.opacity = "0";
                        setTimeout(() => {
                            statusEl.style.display = "none";
                        }, 300);
                    }, 3000);
                } else {
                    statusEl.style.display = "flex";
                    statusEl.style.opacity = "1";
                }
            };

            // SSE Connection for real-time updates
            const connectEventStream = () => {
                const streamUrl = `${API_BASE}/stream`;

                updateConnectionStatus("connecting", "Connecting...");

                eventSource = new EventSource(streamUrl);

                eventSource.onopen = () => {
                    console.log("Connected to real-time updates");
                    updateConnectionStatus("connected", "Connected");
                    clearErrorBanner();
                };

                eventSource.onmessage = (event) => {
                    const activityEvent = JSON.parse(event.data);
                    handleActivityEvent(activityEvent);
                };

                eventSource.onerror = (error) => {
                    console.error("Connection error:", error);
                    updateConnectionStatus("disconnected", "Disconnected");
                    showError("Lost connection to server. Reconnecting...");
                    eventSource.close();

                    // Attempt reconnection after 3 seconds
                    if (reconnectTimer) clearTimeout(reconnectTimer);
                    reconnectTimer = setTimeout(() => {
                        connectEventStream();
                    }, 3000);
                };
            };

            const handleActivityEvent = (event) => {
                // Always refresh stats on any event
                loadStats();

                // If this is the selected activity, refresh its details
                if (selectedActivityId === event.activity_id) {
                    loadActivityDetail(event.activity_id);
                }

                // For real-time updates, we only do a full reload for certain critical events
                // or if the activity might have moved between collections
                const criticalEvents = [
                    "Enqueued",
                    "Requeued",
                    "DeadLetter",
                    "Completed",
                    "Failed",
                    "Scheduled",
                    "Retrying",
                    "Started",
                ];
                const shouldReload = criticalEvents.includes(event.event_type);

                if (shouldReload) {
                    // Determine which collection this event affects
                    const eventCollection = getCollectionForEvent(event);

                    // Refresh if viewing the destination collection
                    if (eventCollection === currentCollection) {
                        debouncedReloadActivities();
                    }

                    // Also refresh if the activity moved OUT of the current collection
                    // For example: Completed event should remove from 'processing'
                    const shouldRefreshCurrent =
                        (event.event_type === "Completed" &&
                            currentCollection === "processing") ||
                        (event.event_type === "Failed" &&
                            currentCollection === "processing") ||
                        (event.event_type === "DeadLetter" &&
                            currentCollection === "processing") ||
                        (event.event_type === "Started" &&
                            (currentCollection === "pending" ||
                                currentCollection === "scheduled")) ||
                        (event.event_type === "Scheduled" &&
                            currentCollection === "processing") ||
                        (event.event_type === "Retrying" &&
                            currentCollection === "processing") ||
                        (event.event_type === "Requeued" &&
                            currentCollection === "dead_letter");

                    if (shouldRefreshCurrent) {
                        debouncedReloadActivities();
                    }
                }
            };

            // Debounced reload to prevent rapid successive reloads
            let reloadTimer = null;
            const debouncedReloadActivities = () => {
                if (reloadTimer) clearTimeout(reloadTimer);
                reloadTimer = setTimeout(() => {
                    loadActivitiesQuiet(currentCollection);
                }, 500);
            };

            // Silent reload without loading skeleton
            const loadActivitiesQuiet = async (collection) => {
                try {
                    const data = await fetchJSON(
                        `${API_BASE}/activities/${collection}?limit=${activityLimit}`,
                    );
                    activities = data;

                    // Update activity types for filter dropdown
                    data.forEach((activity) =>
                        allActivityTypes.add(activity.activity_type),
                    );
                    updateActivityTypeFilter();

                    // Apply filters
                    applyFilters();
                } catch (error) {
                    console.error("Failed to load activities:", error);
                }
            };

            const getCollectionForEvent = (event) => {
                switch (event.event_type) {
                    case "Enqueued":
                    case "Requeued":
                        return "pending";
                    case "Started":
                    case "LeaseExtended":
                        return "processing";
                    case "Scheduled":
                    case "Retrying":
                        return "scheduled";
                    case "Completed":
                        return "completed";
                    case "DeadLetter":
                        return "dead_letter";
                    case "Failed":
                        return "processing"; // Might be in processing before completion
                    default:
                        return null;
                }
            };

            const clearErrorBanner = () => {
                document.getElementById("error-container").innerHTML = "";
            };

            // Theme Management
            const getTheme = () => {
                return localStorage.getItem("theme") || "dark";
            };

            const setTheme = (theme) => {
                localStorage.setItem("theme", theme);
                document.documentElement.setAttribute("data-theme", theme);
                const themeIcon = document.getElementById("theme-icon");
                if (themeIcon) {
                    themeIcon.textContent = theme === "light" ? "🌙" : "☀️";
                }
            };

            const initTheme = () => {
                const theme = getTheme();
                setTheme(theme);
            };

            const toggleTheme = () => {
                const currentTheme = getTheme();
                const newTheme = currentTheme === "dark" ? "light" : "dark";
                setTheme(newTheme);
            };

            // Initialization
            document.addEventListener("DOMContentLoaded", () => {
                // Initialize theme
                initTheme();

                // Setup theme toggle
                const themeToggle = document.getElementById("theme-toggle");
                if (themeToggle) {
                    themeToggle.addEventListener("click", toggleTheme);
                }

                // Setup tab listeners
                document.querySelectorAll(".tabs button").forEach((btn) => {
                    btn.addEventListener("click", () => {
                        switchCollection(btn.dataset.collection);
                    });
                });

                // Setup search and filter listeners
                const searchInput = document.getElementById("search-input");
                const filterTypeSelect = document.getElementById("filter-type");
                const clearFiltersBtn =
                    document.getElementById("clear-filters");

                let searchDebounce = null;
                searchInput.addEventListener("input", (e) => {
                    clearTimeout(searchDebounce);
                    searchDebounce = setTimeout(() => {
                        searchTerm = e.target.value;
                        applyFilters();
                    }, 300);
                });

                filterTypeSelect.addEventListener("change", (e) => {
                    filterType = e.target.value;
                    applyFilters();
                });

                clearFiltersBtn.addEventListener("click", () => {
                    searchInput.value = "";
                    filterTypeSelect.value = "";
                    searchTerm = "";
                    filterType = "";
                    applyFilters();
                });

                // Setup limit selector
                const limitSelect = document.getElementById("limit-select");
                const limitCustomInput =
                    document.getElementById("limit-custom-input");

                // Initialize limit selector with saved value
                const savedLimit =
                    localStorage.getItem("runnerq_activity_limit") || "50";
                if (["10", "50", "100"].includes(savedLimit)) {
                    limitSelect.value = savedLimit;
                } else {
                    limitSelect.value = "custom";
                    limitCustomInput.value = savedLimit;
                    limitCustomInput.classList.add("visible");
                }

                limitSelect.addEventListener("change", (e) => {
                    const value = e.target.value;
                    if (value === "custom") {
                        limitCustomInput.classList.add("visible");
                        limitCustomInput.focus();
                        // Use current value if custom input has one
                        if (limitCustomInput.value) {
                            activityLimit =
                                parseInt(limitCustomInput.value, 10) || 50;
                            localStorage.setItem(
                                "runnerq_activity_limit",
                                activityLimit.toString(),
                            );
                            loadActivities(currentCollection);
                        }
                    } else {
                        limitCustomInput.classList.remove("visible");
                        activityLimit = parseInt(value, 10);
                        localStorage.setItem("runnerq_activity_limit", value);
                        loadActivities(currentCollection);
                    }
                });

                limitCustomInput.addEventListener("change", (e) => {
                    const value = parseInt(e.target.value, 10);
                    if (value > 0 && value <= 1000) {
                        activityLimit = value;
                        localStorage.setItem(
                            "runnerq_activity_limit",
                            value.toString(),
                        );
                        loadActivities(currentCollection);
                    } else {
                        // Reset to last valid value
                        e.target.value = activityLimit;
                    }
                });

                limitCustomInput.addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        e.target.blur(); // Trigger change event
                    }
                });

                // Initial load
                loadStats();
                loadActivities(currentCollection);

                // Connect to SSE for real-time updates
                connectEventStream();
            });

            // Cleanup on page unload
            window.addEventListener("beforeunload", () => {
                if (eventSource) {
                    eventSource.close();
                }
                if (reconnectTimer) {
                    clearTimeout(reconnectTimer);
                }
            });

            // Copy to clipboard function
            const copyToClipboard = async (elementId, button) => {
                const element = document.getElementById(elementId);
                if (!element) return;

                try {
                    await navigator.clipboard.writeText(element.textContent);
                    const originalText = button.textContent;
                    button.textContent = "✓ Copied!";
                    button.classList.add("copied");

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove("copied");
                    }, 2000);
                } catch (err) {
                    console.error("Failed to copy:", err);
                }
            };

            // Filter by status function
            const filterByStatus = (status) => {
                if (!status) return;

                // Map status to collection
                const statusToCollection = {
                    running: "processing",
                    processing: "processing",
                    started: "processing",
                    dequeued: "processing",
                    pending: "pending",
                    enqueued: "pending",
                    queued: "pending",
                    completed: "completed",
                    success: "completed",
                    succeeded: "completed",
                    failed: "dead_letter",
                    error: "dead_letter",
                    dead_letter: "dead_letter",
                    deadletter: "dead_letter",
                    scheduled: "scheduled",
                    scheduled_future: "scheduled",
                };

                // Normalize status to lowercase for lookup
                const normalizedStatus = status.toLowerCase().trim();
                const collection = statusToCollection[normalizedStatus];

                // If we found a matching collection, switch to it
                if (collection) {
                    switchCollection(collection);
                } else {
                    // Gracefully handle unknown status - default to pending
                    console.warn(
                        `Unknown status "${status}", defaulting to pending collection`,
                    );
                    switchCollection("pending");
                }
            };

            // Make functions globally accessible
            window.selectActivity = selectActivity;
            window.clearDetailPanel = clearDetailPanel;
            window.copyToClipboard = copyToClipboard;
            window.setTimelineView = setTimelineView;
            window.sortBy = sortBy;
            window.filterByStatus = filterByStatus;
            window.filterByPriority = filterByPriority;
            window.switchCollection = switchCollection;
            window.copyEventHistory = copyEventHistory;
            window.exportEventHistory = exportEventHistory;
        </script>
    </body>
</html>
